services:
  app:
    image: bellitek-app
    container_name: bellitek_app
    build:
      context: .
      args:
        VITE_APP_URL: https://bellitek.com.ng

    restart: unless-stopped

    # App listens internally on port 80
    # Nginx should proxy to 8080
    ports:
      - "127.0.0.1:8080:80"

    environment:
      APP_ENV: production
      APP_KEY: base64:7O6J+Y7VZ8Vp1oLfwMWpLAYMd0bM+dkW6t1f2ZBbw0g=
      APP_DEBUG: "false"
      APP_URL: https://bellitek.com.ng
      ASSET_URL: https://bellitek.com.ng

      # APP_NAME: Bellitek
      # APP_ENV: local                             # Changed to 'local' for development
      # APP_KEY: base64:Zi/HmT3/DKlJFBliXnk9ocAlN0eEg6l/FpWGYdFI/W8=
      # APP_DEBUG: true                            # Changed to 'true' to see errors
      # APP_URL: http://localhost:8000             # Changed to local URL
      # VITE_APP_URL: http://localhost:8000 

      # Database
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: bellitek
      DB_USERNAME: bellitek_user
      DB_PASSWORD: strongpassword

      # Sessions (419-safe)
      SESSION_DRIVER: database
      SESSION_DOMAIN: .bellitek.com.ng
      SESSION_SECURE_COOKIE: "true"
      SESSION_SAME_SITE: lax

      # Reverse proxy safety
      TRUSTED_PROXIES: "*"

    depends_on:
      - db

    volumes:
      # Persist Laravel runtime state only
      - bellitek_app_storage:/var/www/app/storage

  db:
    image: postgres:16
    container_name: bellitek_db
    restart: unless-stopped

    environment:
      POSTGRES_DB: bellitek
      POSTGRES_USER: bellitek_user
      POSTGRES_PASSWORD: strongpassword

    # OPTIONAL: expose only if you really need external DB access
    # Recommended to REMOVE in production
    # ports:
    #   - "5432:5432"

    volumes:
      # This is the ONLY place Postgres data lives
      - bellitek_db_data:/var/lib/postgresql/data

volumes:
  bellitek_db_data:
    name: bellitek_persistent_db_data

  bellitek_app_storage:
    name: bellitek_persistent_storage
